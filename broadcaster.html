<!DOCTYPE html>
<html>
<head>
    <title>ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© - Ø§Ù„Ø¨Ø«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        video { width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 5px; margin: 10px 0; }
        #status { color: #666; margin: 10px; }
        .control-group { margin: 15px 0; }
        select, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

    <h2>ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø« ğŸ¥</h2>
    <p>Ø³ÙŠØªÙ… Ø¨Ø« ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¢Ù†.</p>
    
    <div class="control-group">
        <label for="qualitySelect">Ø§Ø®ØªØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«: </label>
        <select id="qualitySelect">
            <option value="high">Ø¹Ø§Ù„ÙŠØ© (HD)</option>
            <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø© (Ù…ØªÙˆØ§Ø²Ù†Ø©)</option>
            <option value="low">Ù…Ù†Ø®ÙØ¶Ø© (Ù„Ù„Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø§Ù„Ø¶Ø¹ÙŠÙ)</option>
            <option value="audioOnly">Ø§Ù„ØµÙˆØª ÙÙ‚Ø·</option>
        </select>
    </div>
    
    <button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
    <button id="stopBtn" disabled>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
    
    <video id="localVideo" autoplay muted playsinline></video>
    <p id="status">Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø«Ù… Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«".</p>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');
        const qualitySelect = document.getElementById('qualitySelect');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        
        const BROADCASTER_ID = "surveillance_camera_001";
        let peer = null;
        let currentStream = null;

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        const qualityProfiles = {
            high: {
                video: { width: 1280, height: 720, frameRate: 30 },
                audio: true
            },
            medium: {
                video: { width: 640, height: 480, frameRate: 20 },
                audio: true
            },
            low: {
                video: { width: 320, height: 240, frameRate: 15 },
                audio: true
            },
            audioOnly: {
                video: false,
                audio: true
            }
        };

        startBtn.addEventListener('click', startBroadcast);
        stopBtn.addEventListener('click', stopBroadcast);

        function startBroadcast() {
            const quality = qualitySelect.value;
            const constraints = qualityProfiles[quality];
            
            statusEl.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";
            startBtn.disabled = true;
            qualitySelect.disabled = true;

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    localVideo.srcObject = stream;
                    
                    // ØªÙ‡ÙŠØ¦Ø© PeerJS Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…
                    peer = new Peer(BROADCASTER_ID, {
                        host: 'peerjs-server-0yb0.onrender.com',
                        port: 443,
                        path: '/',
                        secure: true,
                        debug: 2
                    });

                    peer.on('open', function(id) {
                        statusEl.textContent = `Ø§Ù„Ø¨Ø« Ù†Ø´Ø· (${quality}) - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ âœ…`;
                        statusEl.style.color = 'green';
                        stopBtn.disabled = false;
                        console.log('Broadcaster ID:', id);
                    });

                    peer.on('error', function(err) {
                        console.error('PeerJS error:', err);
                        statusEl.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.type;
                        statusEl.style.color = 'red';
                    });

                })
                .catch(function(err) {
                    statusEl.textContent = "Ø®Ø·Ø£: " + err.message;
                    statusEl.style.color = 'red';
                    startBtn.disabled = false;
                    qualitySelect.disabled = false;
                    console.error('Error accessing media:', err);
                });
        }

        function stopBroadcast() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            localVideo.srcObject = null;
            statusEl.textContent = "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
            statusEl.style.color = '#666';
            startBtn.disabled = false;
            qualitySelect.disabled = false;
            stopBtn.disabled = true;
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø« Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', stopBroadcast);
    </script>
</body>
</html>