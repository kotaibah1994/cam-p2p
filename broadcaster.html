<!DOCTYPE html>
<html>
<head>
    <title>كاميرا المراقبة - البث</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        video { width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 5px; margin: 10px 0; }
        #status { color: #666; margin: 10px; }
        .control-group { margin: 15px 0; }
        select, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

    <h2>وضع البث 🎥</h2>
    <p>سيتم بث كاميرا الهاتف الآن.</p>
    
    <div class="control-group">
        <label for="qualitySelect">اختر جودة البث: </label>
        <select id="qualitySelect">
            <option value="high">عالية (HD)</option>
            <option value="medium" selected>متوسطة (متوازنة)</option>
            <option value="low">منخفضة (للالإنترنت الضعيف)</option>
            <option value="audioOnly">الصوت فقط</option>
        </select>
    </div>
    
    <button id="startBtn">بدء البث</button>
    <button id="stopBtn" disabled>إيقاف البث</button>
    
    <video id="localVideo" autoplay muted playsinline></video>
    <p id="status">اختر الجودة ثم اضغط "بدء البث".</p>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');
        const qualitySelect = document.getElementById('qualitySelect');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        
        const BROADCASTER_ID = "surveillance_camera_001";
        let peer = null;
        let currentStream = null;

        // إعدادات الجودة المختلفة
        const qualityProfiles = {
            high: {
                video: { width: 1280, height: 720, frameRate: 30 },
                audio: true
            },
            medium: {
                video: { width: 640, height: 480, frameRate: 20 },
                audio: true
            },
            low: {
                video: { width: 320, height: 240, frameRate: 15 },
                audio: true
            },
            audioOnly: {
                video: false,
                audio: true
            }
        };

        startBtn.addEventListener('click', startBroadcast);
        stopBtn.addEventListener('click', stopBroadcast);

        function startBroadcast() {
            const quality = qualitySelect.value;
            const constraints = qualityProfiles[quality];
            
            statusEl.textContent = "جاري تشغيل الكاميرا...";
            startBtn.disabled = true;
            qualitySelect.disabled = true;

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    localVideo.srcObject = stream;
                    
                    // تهيئة PeerJS مع الخادم
                    peer = new Peer(BROADCASTER_ID, {
                        host: 'peerjs-server-0yb0.onrender.com',
                        port: 443,
                        path: '/',
                        secure: true,
                        debug: 2
                    });

                    peer.on('open', function(id) {
                        statusEl.textContent = `البث نشط (${quality}) - جاهز للاستقبال ✅`;
                        statusEl.style.color = 'green';
                        stopBtn.disabled = false;
                        console.log('Broadcaster ID:', id);
                    });

                    peer.on('error', function(err) {
                        console.error('PeerJS error:', err);
                        statusEl.textContent = "خطأ في الاتصال: " + err.type;
                        statusEl.style.color = 'red';
                    });

                })
                .catch(function(err) {
                    statusEl.textContent = "خطأ: " + err.message;
                    statusEl.style.color = 'red';
                    startBtn.disabled = false;
                    qualitySelect.disabled = false;
                    console.error('Error accessing media:', err);
                });
        }

        function stopBroadcast() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            localVideo.srcObject = null;
            statusEl.textContent = "تم إيقاف البث. يمكنك البدء مرة أخرى.";
            statusEl.style.color = '#666';
            startBtn.disabled = false;
            qualitySelect.disabled = false;
            stopBtn.disabled = true;
        }

        // إغلاق البث عند مغادرة الصفحة
        window.addEventListener('beforeunload', stopBroadcast);
    </script>
</body>
</html>