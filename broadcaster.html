<!DOCTYPE html>
<html>
<head>
    <title>كاميرا المراقبة - البث</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        video { 
            width: 100%; 
            max-width: 400px; 
            border: 2px solid #007bff; 
            border-radius: 10px; 
            margin: 15px 0; 
            background-color: #000;
        }
        #status { 
            color: #666; 
            margin: 15px; 
            font-size: 16px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            min-height: 60px;
        }
        .control-group { 
            margin: 20px 0; 
        }
        select, button { 
            padding: 12px 16px; 
            margin: 8px; 
            border-radius: 8px; 
            border: 2px solid #ddd;
            font-size: 16px;
        }
        select {
            width: 250px;
            background-color: white;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer;
            min-width: 120px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed;
        }
        .quality-info {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected { background-color: #2ecc71; }
        .waiting { background-color: #f39c12; }
        .disconnected { background-color: #e74c3c; }
    </style>
</head>
<body>

    <h2>🎥 وضع البث - كاميرا المراقبة</h2>
    <p>اختر جودة البث ثم ابدأ البث</p>
    
    <div class="control-group">
        <label for="qualitySelect"><strong>جودة البث:</strong></label><br>
        <select id="qualitySelect">
            <option value="high">عالي الجودة (HD - 720p)</option>
            <option value="medium" selected>متوسط (متوازن - 480p)</option>
            <option value="low">منخفض (للالإنترنت البطيء - 240p)</option>
            <option value="audioOnly">الصوت فقط (بدون فيديو)</option>
        </select>
        <div class="quality-info" id="qualityInfo">متوسط: 640x480 - 20fps</div>
    </div>
    
    <div class="control-group">
        <button id="startBtn">▶️ بدء البث</button>
        <button id="stopBtn" disabled>⏹️ إيقاف البث</button>
    </div>
    
    <video id="localVideo" autoplay muted playsinline></video>
    
    <div id="status">
        <span class="connection-status disconnected"></span>
        👉 اختر الجودة ثم اضغط "بدء البث"
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // عناصر DOM
        const statusEl = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');
        const qualitySelect = document.getElementById('qualitySelect');
        const qualityInfo = document.getElementById('qualityInfo');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const connectionStatus = statusEl.querySelector('.connection-status');
        
        const BROADCASTER_ID = "surveillance_camera_001";
        let peer = null;
        let currentStream = null;
        let isBroadcasting = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // إعدادات الجودة المختلفة
        const qualityProfiles = {
            high: {
                video: { 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 }, 
                    frameRate: { ideal: 30 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100,
                    sampleSize: 16 
                }
            },
            medium: {
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }, 
                    frameRate: { ideal: 20 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100 
                }
            },
            low: {
                video: { 
                    width: { ideal: 320 }, 
                    height: { ideal: 240 }, 
                    frameRate: { ideal: 15 } 
                },
                audio: true
            },
            audioOnly: {
                video: false,
                audio: true
            }
        };

        // معلومات الجودة للعرض
        const qualityDescriptions = {
            high: "عالي: 1280x720 - 30fps",
            medium: "متوسط: 640x480 - 20fps",
            low: "منخفض: 320x240 - 15fps",
            audioOnly: "الصوت فقط"
        };

        // تحديث حالة الاتصال
        function updateConnectionStatus(status, message) {
            connectionStatus.className = 'connection-status ' + status;
            statusEl.innerHTML = `<span class="connection-status ${status}"></span> ${message}`;
        }

        // الأحداث
        startBtn.addEventListener('click', startBroadcast);
        stopBtn.addEventListener('click', stopBroadcast);
        qualitySelect.addEventListener('change', updateQualityInfo);

        // تحديث معلومات الجودة
        function updateQualityInfo() {
            const quality = qualitySelect.value;
            qualityInfo.textContent = qualityDescriptions[quality];
        }

        // بدء البث
        function startBroadcast() {
            const quality = qualitySelect.value;
            const constraints = qualityProfiles[quality];
            
            updateConnectionStatus('waiting', '🔄 جاري تشغيل الكاميرا والصوت...');
            startBtn.disabled = true;
            qualitySelect.disabled = true;
            isBroadcasting = true;
            reconnectAttempts = 0;

            // تحقق من تحميل مكتبة PeerJS
            if (typeof Peer === 'undefined') {
                updateConnectionStatus('disconnected', '❌ خطأ: لم يتم تحميل مكتبة PeerJS');
                startBtn.disabled = false;
                qualitySelect.disabled = false;
                isBroadcasting = false;
                return;
            }

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    localVideo.srcObject = stream;
                    
                    // استخدام خادم إشارة مختلف - خادم PeerJS الرسمي
                    peer = new Peer(BROADCASTER_ID, {
                        host: '0.peerjs.com',
                        port: 443,
                        path: '/',
                        secure: true,
                        debug: 3,
                        config: {
                            iceServers: [
                                { 
                                    urls: [
                                        'stun:stun.l.google.com:19302',
                                        'stun:stun1.l.google.com:19302',
                                        'stun:stun2.l.google.com:19302',
                                        'stun:stun3.l.google.com:19302',
                                        'stun:stun4.l.google.com:19302'
                                    ] 
                                }
                            ]
                        }
                    });

                    peer.on('open', function(id) {
                        reconnectAttempts = 0; // إعادة تعيين محاولات إعادة الاتصال
                        updateConnectionStatus('connected', 
                            `✅ <strong>البث نشط!</strong><br>جودة: ${qualityDescriptions[quality]}<br>` +
                            `📍 في انتظار المستقبل...<br>` +
                            `⏳ البث سيستمر حتى إيقافه يدوياً`
                        );
                        stopBtn.disabled = false;
                        console.log('✅ Connected to signaling server. ID:', id);
                    });

                    peer.on('error', function(err) {
                        console.error('❌ PeerJS error:', err);
                        
                        if (err.type === 'peer-unavailable') {
                            // هذا الخطأ طبيعي يعني عدم وجود مستقبل بعد
                            updateConnectionStatus('waiting', 
                                '⏳ في انتظار المستقبل...<br>' +
                                '👀 افتح صفحة المشاهدة على جهاز آخر'
                            );
                        } else if (err.type === 'network' || err.type === 'server-error') {
                            // خطأ في الشبكة أو الخادم - حاول إعادة الاتصال
                            handleNetworkError();
                        } else {
                            updateConnectionStatus('disconnected', 
                                `❌ خطأ في الاتصال: ${err.type}<br>جرب تحديث الصفحة`
                            );
                            stopBroadcast();
                        }
                    });

                    peer.on('disconnected', function() {
                        updateConnectionStatus('waiting', '⚠️ الاتصال انقطع. جاري إعادة الاتصال...');
                        handleDisconnection();
                    });

                    peer.on('close', function() {
                        console.log('🔌 Peer connection closed');
                        if (isBroadcasting) {
                            handleDisconnection();
                        }
                    });

                })
                .catch(function(err) {
                    updateConnectionStatus('disconnected', 
                        `❌ <strong>خطأ:</strong> ${err.name}<br>${err.message}`
                    );
                    startBtn.disabled = false;
                    qualitySelect.disabled = false;
                    isBroadcasting = false;
                    console.error('Error accessing media:', err);
                });
        }

        // التعامل مع انقطاع الاتصال
        function handleDisconnection() {
            if (!isBroadcasting || reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                updateConnectionStatus('disconnected', 
                    '❌ انقطع الاتصال بشكل دائم. يرجى تحديث الصفحة والمحاولة مرة أخرى.'
                );
                stopBroadcast();
                return;
            }

            reconnectAttempts++;
            const delay = Math.min(3000 * reconnectAttempts, 15000); // زيادة التأخير تدريجياً
            
            updateConnectionStatus('waiting', 
                `⚠️ محاولة إعادة الاتصال ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}...`
            );
            
            setTimeout(() => {
                if (isBroadcasting && peer) {
                    peer.reconnect();
                }
            }, delay);
        }

        // التعامل مع أخطاء الشبكة
        function handleNetworkError() {
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                updateConnectionStatus('disconnected', 
                    '❌ فشل الاتصال بالخادم بعد عدة محاولات. جرب خادمًا آخر.'
                );
                stopBroadcast();
                return;
            }

            reconnectAttempts++;
            const delay = 2000 * reconnectAttempts;
            
            updateConnectionStatus('waiting', 
                `🔧 مشكلة في الشبكة. المحاولة ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}...`
            );
            
            setTimeout(() => {
                if (isBroadcasting) {
                    // إنشاء اتصال جديد بدلاً من إعادة الاتصال
                    stopBroadcast();
                    setTimeout(startBroadcast, 500);
                }
            }, delay);
        }

        // إيقاف البث
        function stopBroadcast() {
            isBroadcasting = false;
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            localVideo.srcObject = null;
            updateConnectionStatus('disconnected', 
                '⏸️ <strong>تم إيقاف البث</strong><br>يمكنك البدء مرة أخرى'
            );
            startBtn.disabled = false;
            qualitySelect.disabled = false;
            stopBtn.disabled = true;
        }

        // إغلاق البث عند مغادرة الصفحة
        window.addEventListener('beforeunload', function(e) {
            if (isBroadcasting) {
                e.preventDefault();
                e.returnValue = '⚠️ البث لا يزال نشطاً. هل تريد المغادرة؟';
            }
        });
        
        window.addEventListener('pagehide', stopBroadcast);
        
        // تهيئة أولية
        updateQualityInfo();
        console.log('✅ Page loaded successfully');
    </script>
</body>
</html>