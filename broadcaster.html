<!DOCTYPE html>
<html>
<head>
    <title>ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© - Ø§Ù„Ø¨Ø«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        video { 
            width: 100%; 
            max-width: 400px; 
            border: 2px solid #007bff; 
            border-radius: 10px; 
            margin: 15px 0; 
            background-color: #000;
        }
        #status { 
            color: #666; 
            margin: 15px; 
            font-size: 16px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .control-group { 
            margin: 20px 0; 
        }
        select, button { 
            padding: 12px 16px; 
            margin: 8px; 
            border-radius: 8px; 
            border: 2px solid #ddd;
            font-size: 16px;
        }
        select {
            width: 250px;
            background-color: white;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer;
            min-width: 120px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed;
        }
        .quality-info {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h2>ğŸ¥ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø« - ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</h2>
    <p>Ø§Ø®ØªØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø« Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø«</p>
    
    <div class="control-group">
        <label for="qualitySelect"><strong>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«:</strong></label><br>
        <select id="qualitySelect">
            <option value="high">Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© (HD - 720p)</option>
            <option value="medium" selected>Ù…ØªÙˆØ³Ø· (Ù…ØªÙˆØ§Ø²Ù† - 480p)</option>
            <option value="low">Ù…Ù†Ø®ÙØ¶ (Ù„Ù„Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø§Ù„Ø¨Ø·ÙŠØ¡ - 240p)</option>
            <option value="audioOnly">Ø§Ù„ØµÙˆØª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ÙÙŠØ¯ÙŠÙˆ)</option>
        </select>
        <div class="quality-info" id="qualityInfo">Ù…ØªÙˆØ³Ø·: 640x480 - 20fps</div>
    </div>
    
    <div class="control-group">
        <button id="startBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
        <button id="stopBtn" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
    </div>
    
    <video id="localVideo" autoplay muted playsinline></video>
    <p id="status">ğŸ‘‰ Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø«Ù… Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«"</p>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // Ø¹Ù†Ø§ØµØ± DOM
        const statusEl = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');
        const qualitySelect = document.getElementById('qualitySelect');
        const qualityInfo = document.getElementById('qualityInfo');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        
        const BROADCASTER_ID = "surveillance_camera_001";
        let peer = null;
        let currentStream = null;
        let connectionTimeout = null;

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        const qualityProfiles = {
            high: {
                video: { 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 }, 
                    frameRate: { ideal: 30 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100,
                    sampleSize: 16 
                }
            },
            medium: {
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }, 
                    frameRate: { ideal: 20 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100 
                }
            },
            low: {
                video: { 
                    width: { ideal: 320 }, 
                    height: { ideal: 240 }, 
                    frameRate: { ideal: 15 } 
                },
                audio: true
            },
            audioOnly: {
                video: false,
                audio: true
            }
        };

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ù„Ø¹Ø±Ø¶
        const qualityDescriptions = {
            high: "Ø¹Ø§Ù„ÙŠ: 1280x720 - 30fps",
            medium: "Ù…ØªÙˆØ³Ø·: 640x480 - 20fps",
            low: "Ù…Ù†Ø®ÙØ¶: 320x240 - 15fps",
            audioOnly: "Ø§Ù„ØµÙˆØª ÙÙ‚Ø·"
        };

        // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        startBtn.addEventListener('click', startBroadcast);
        stopBtn.addEventListener('click', stopBroadcast);
        qualitySelect.addEventListener('change', updateQualityInfo);

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©
        function updateQualityInfo() {
            const quality = qualitySelect.value;
            qualityInfo.textContent = qualityDescriptions[quality];
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
        function startBroadcast() {
            const quality = qualitySelect.value;
            const constraints = qualityProfiles[quality];
            
            statusEl.textContent = "ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØµÙˆØª...";
            statusEl.style.color = '#666';
            startBtn.disabled = true;
            qualitySelect.disabled = true;

            // ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© PeerJS
            if (typeof Peer === 'undefined') {
                statusEl.textContent = 'âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© PeerJS. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
                statusEl.style.color = 'red';
                startBtn.disabled = false;
                qualitySelect.disabled = false;
                return;
            }

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    localVideo.srcObject = stream;
                    
                    // Ø§Ù„Ø­Ù„ 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§Ø¯Ù… Ø¥Ø´Ø§Ø±Ø© Ø¨Ø¯ÙŠÙ„
                    peer = new Peer(BROADCASTER_ID, {
                        host: 'signaling.herokuapp.com',  // Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¯ÙŠÙ„
                        port: 443,
                        path: '/',
                        secure: true,
                        debug: 3,
                        config: {
                            iceServers: [
                                { 
                                    urls: [
                                        'stun:stun.l.google.com:19302',
                                        'stun:global.stun.twilio.com:3478'
                                    ] 
                                }
                            ]
                        }
                    });

                    // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¬Ù…Ø¯
                    connectionTimeout = setTimeout(() => {
                        if (peer && !peer.disconnected) {
                            statusEl.innerHTML = 'â° <strong>Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù†ØªÙ‡Øª</strong><br>Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨. Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.';
                            statusEl.style.color = 'orange';
                            stopBroadcast();
                        }
                    }, 15000); // 15 Ø«Ø§Ù†ÙŠØ©

                    peer.on('open', function(id) {
                        clearTimeout(connectionTimeout);
                        statusEl.innerHTML = "âœ… <strong>Ø§Ù„Ø¨Ø« Ù†Ø´Ø·!</strong><br>Ø¬ÙˆØ¯Ø©: " + qualityDescriptions[quality] + "<br>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„";
                        statusEl.style.color = 'green';
                        stopBtn.disabled = false;
                        console.log('âœ… Connected to signaling server. ID:', id);
                    });

                    peer.on('error', function(err) {
                        clearTimeout(connectionTimeout);
                        console.error('âŒ PeerJS error:', err);
                        statusEl.innerHTML = "âŒ <strong>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:</strong> " + err.type + "<br>Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©";
                        statusEl.style.color = 'red';
                        stopBroadcast();
                    });

                    peer.on('disconnected', function() {
                        statusEl.textContent = "âš ï¸ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...";
                        statusEl.style.color = 'orange';
                    });

                    peer.on('close', function() {
                        console.log('ğŸ”Œ Peer connection closed');
                    });

                })
                .catch(function(err) {
                    clearTimeout(connectionTimeout);
                    statusEl.innerHTML = "âŒ <strong>Ø®Ø·Ø£:</strong> " + err.name + "<br>" + err.message;
                    statusEl.style.color = 'red';
                    startBtn.disabled = false;
                    qualitySelect.disabled = false;
                    console.error('Error accessing media:', err);
                });
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
        function stopBroadcast() {
            clearTimeout(connectionTimeout);
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            localVideo.srcObject = null;
            statusEl.innerHTML = "â¸ï¸ <strong>ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</strong><br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
            statusEl.style.color = '#666';
            startBtn.disabled = false;
            qualitySelect.disabled = false;
            stopBtn.disabled = true;
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø« Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', stopBroadcast);
        window.addEventListener('pagehide', stopBroadcast);
        
        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
        updateQualityInfo();
        console.log('âœ… Page loaded successfully');
    </script>
</body>
</html>