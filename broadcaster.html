<!DOCTYPE html>
<html>
<head>
    <title>ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© - Ø§Ù„Ø¨Ø«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        video { 
            width: 100%; 
            max-width: 400px; 
            border: 2px solid #007bff; 
            border-radius: 10px; 
            margin: 15px 0; 
            background-color: #000;
        }
        #status { 
            color: #666; 
            margin: 15px; 
            font-size: 16px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            min-height: 60px;
        }
        .control-group { 
            margin: 20px 0; 
        }
        select, button { 
            padding: 12px 16px; 
            margin: 8px; 
            border-radius: 8px; 
            border: 2px solid #ddd;
            font-size: 16px;
        }
        select {
            width: 250px;
            background-color: white;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer;
            min-width: 120px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed;
        }
        .quality-info {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected { background-color: #2ecc71; }
        .waiting { background-color: #f39c12; }
        .disconnected { background-color: #e74c3c; }
    </style>
</head>
<body>

    <h2>ğŸ¥ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø« - ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</h2>
    <p>Ø§Ø®ØªØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø« Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø«</p>
    
    <div class="control-group">
        <label for="qualitySelect"><strong>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«:</strong></label><br>
        <select id="qualitySelect">
            <option value="high">Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© (HD - 720p)</option>
            <option value="medium" selected>Ù…ØªÙˆØ³Ø· (Ù…ØªÙˆØ§Ø²Ù† - 480p)</option>
            <option value="low">Ù…Ù†Ø®ÙØ¶ (Ù„Ù„Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø§Ù„Ø¨Ø·ÙŠØ¡ - 240p)</option>
            <option value="audioOnly">Ø§Ù„ØµÙˆØª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ÙÙŠØ¯ÙŠÙˆ)</option>
        </select>
        <div class="quality-info" id="qualityInfo">Ù…ØªÙˆØ³Ø·: 640x480 - 20fps</div>
    </div>
    
    <div class="control-group">
        <button id="startBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
        <button id="stopBtn" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
    </div>
    
    <video id="localVideo" autoplay muted playsinline></video>
    
    <div id="status">
        <span class="connection-status disconnected"></span>
        ğŸ‘‰ Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø«Ù… Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«"
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // Ø¹Ù†Ø§ØµØ± DOM
        const statusEl = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');
        const qualitySelect = document.getElementById('qualitySelect');
        const qualityInfo = document.getElementById('qualityInfo');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const connectionStatus = statusEl.querySelector('.connection-status');
        
        const BROADCASTER_ID = "surveillance_camera_001";
        let peer = null;
        let currentStream = null;
        let connectionTimeout = null;
        let isBroadcasting = false;

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        const qualityProfiles = {
            high: {
                video: { 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 }, 
                    frameRate: { ideal: 30 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100,
                    sampleSize: 16 
                }
            },
            medium: {
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }, 
                    frameRate: { ideal: 20 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100 
                }
            },
            low: {
                video: { 
                    width: { ideal: 320 }, 
                    height: { ideal: 240 }, 
                    frameRate: { ideal: 15 } 
                },
                audio: true
            },
            audioOnly: {
                video: false,
                audio: true
            }
        };

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ù„Ø¹Ø±Ø¶
        const qualityDescriptions = {
            high: "Ø¹Ø§Ù„ÙŠ: 1280x720 - 30fps",
            medium: "Ù…ØªÙˆØ³Ø·: 640x480 - 20fps",
            low: "Ù…Ù†Ø®ÙØ¶: 320x240 - 15fps",
            audioOnly: "Ø§Ù„ØµÙˆØª ÙÙ‚Ø·"
        };

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus(status, message) {
            connectionStatus.className = 'connection-status ' + status;
            statusEl.innerHTML = `<span class="connection-status ${status}"></span> ${message}`;
        }

        // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        startBtn.addEventListener('click', startBroadcast);
        stopBtn.addEventListener('click', stopBroadcast);
        qualitySelect.addEventListener('change', updateQualityInfo);

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©
        function updateQualityInfo() {
            const quality = qualitySelect.value;
            qualityInfo.textContent = qualityDescriptions[quality];
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
        function startBroadcast() {
            const quality = qualitySelect.value;
            const constraints = qualityProfiles[quality];
            
            updateConnectionStatus('waiting', 'ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØµÙˆØª...');
            startBtn.disabled = true;
            qualitySelect.disabled = true;
            isBroadcasting = true;

            // ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© PeerJS
            if (typeof Peer === 'undefined') {
                updateConnectionStatus('disconnected', 'âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© PeerJS');
                startBtn.disabled = false;
                qualitySelect.disabled = false;
                return;
            }

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    localVideo.srcObject = stream;
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§Ø¯Ù… Ø¥Ø´Ø§Ø±Ø© Ø¨Ø¯ÙŠÙ„
                    peer = new Peer(BROADCASTER_ID, {
                        host: 'signaling.herokuapp.com',
                        port: 443,
                        path: '/',
                        secure: true,
                        debug: 3,
                        config: {
                            iceServers: [
                                { 
                                    urls: [
                                        'stun:stun.l.google.com:19302',
                                        'stun:global.stun.twilio.com:3478'
                                    ] 
                                }
                            ]
                        }
                    });

                    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹
                    peer.on('open', function(id) {
                        updateConnectionStatus('connected', 
                            `âœ… <strong>Ø§Ù„Ø¨Ø« Ù†Ø´Ø·!</strong><br>Ø¬ÙˆØ¯Ø©: ${qualityDescriptions[quality]}<br>` +
                            `ğŸ“ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„...<br>` +
                            `â³ Ø§Ù„Ø¨Ø« Ø³ÙŠØ³ØªÙ…Ø± Ø­ØªÙ‰ Ø¥ÙŠÙ‚Ø§ÙÙ‡ ÙŠØ¯ÙˆÙŠØ§Ù‹`
                        );
                        stopBtn.disabled = false;
                        console.log('âœ… Connected to signaling server. ID:', id);
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ Ø§Ù†Ù‚Ø·Ø¹
                        peer.on('disconnected', function() {
                            updateConnectionStatus('waiting', 'âš ï¸ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù†Ù‚Ø·Ø¹. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
                            setTimeout(() => {
                                if (isBroadcasting) {
                                    peer.reconnect();
                                }
                            }, 2000);
                        });
                    });

                    peer.on('error', function(err) {
                        console.error('âŒ PeerJS error:', err);
                        if (err.type === 'peer-unavailable') {
                            // Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ Ø·Ø¨ÙŠØ¹ÙŠ ÙŠØ¹Ù†ÙŠ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªÙ‚Ø¨Ù„ Ø¨Ø¹Ø¯
                            updateConnectionStatus('waiting', 
                                'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„...<br>' +
                                'ğŸ‘€ Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±'
                            );
                        } else {
                            updateConnectionStatus('disconnected', 
                                `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.type}<br>Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©`
                            );
                            stopBroadcast();
                        }
                    });

                    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£ÙŠ Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                    peer.on('connection', function(conn) {
                        console.log('ğŸ”— received connection from:', conn.peer);
                        updateConnectionStatus('connected', 
                            `âœ… <strong>Ù…Ø³ØªÙ‚Ø¨Ù„ Ù…ØªØµÙ„!</strong><br>` +
                            `ğŸ‘¤ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹: ${conn.peer}<br>` +
                            `ğŸ¥ Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ`
                        );
                    });

                    // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø´Ø·Ø§Ù‹
                    setInterval(() => {
                        if (peer && !peer.disconnected) {
                            peer.socket.send({ type: 'keepalive' });
                        }
                    }, 30000); // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø­ÙŠØ© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©

                })
                .catch(function(err) {
                    updateConnectionStatus('disconnected', 
                        `âŒ <strong>Ø®Ø·Ø£:</strong> ${err.name}<br>${err.message}`
                    );
                    startBtn.disabled = false;
                    qualitySelect.disabled = false;
                    isBroadcasting = false;
                    console.error('Error accessing media:', err);
                });
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
        function stopBroadcast() {
            isBroadcasting = false;
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            localVideo.srcObject = null;
            updateConnectionStatus('disconnected', 
                'â¸ï¸ <strong>ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</strong><br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'
            );
            startBtn.disabled = false;
            qualitySelect.disabled = false;
            stopBtn.disabled = true;
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø« Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', function(e) {
            if (isBroadcasting) {
                e.preventDefault();
                e.returnValue = 'âš ï¸ Ø§Ù„Ø¨Ø« Ù„Ø§ ÙŠØ²Ø§Ù„ Ù†Ø´Ø·Ø§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
                return 'âš ï¸ Ø§Ù„Ø¨Ø« Ù„Ø§ ÙŠØ²Ø§Ù„ Ù†Ø´Ø·Ø§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
            }
        });
        
        window.addEventListener('pagehide', stopBroadcast);
        
        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
        updateQualityInfo();
        console.log('âœ… Page loaded successfully');
    </script>
</body>
</html>