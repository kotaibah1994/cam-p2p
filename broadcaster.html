<!DOCTYPE html>
<html>
<head>
    <title>كاميرا المراقبة - البث</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        video { 
            width: 100%; 
            max-width: 400px; 
            border: 2px solid #007bff; 
            border-radius: 10px; 
            margin: 15px 0; 
            background-color: #000;
        }
        #status { 
            color: #666; 
            margin: 15px; 
            font-size: 16px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .control-group { 
            margin: 20px 0; 
        }
        select, button { 
            padding: 12px 16px; 
            margin: 8px; 
            border-radius: 8px; 
            border: 2px solid #ddd;
            font-size: 16px;
        }
        select {
            width: 250px;
            background-color: white;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer;
            min-width: 120px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed;
        }
        .quality-info {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h2>🎥 وضع البث - كاميرا المراقبة</h2>
    <p>اختر جودة البث ثم ابدأ البث</p>
    
    <div class="control-group">
        <label for="qualitySelect"><strong>جودة البث:</strong></label><br>
        <select id="qualitySelect">
            <option value="high">عالي الجودة (HD - 720p)</option>
            <option value="medium" selected>متوسط (متوازن - 480p)</option>
            <option value="low">منخفض (للالإنترنت البطيء - 240p)</option>
            <option value="audioOnly">الصوت فقط (بدون فيديو)</option>
        </select>
        <div class="quality-info" id="qualityInfo">متوسط: 640x480 - 20fps</div>
    </div>
    
    <div class="control-group">
        <button id="startBtn">▶️ بدء البث</button>
        <button id="stopBtn" disabled>⏹️ إيقاف البث</button>
    </div>
    
    <video id="localVideo" autoplay muted playsinline></video>
    <p id="status">👉 اختر الجودة ثم اضغط "بدء البث"</p>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // عناصر DOM
        const statusEl = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');
        const qualitySelect = document.getElementById('qualitySelect');
        const qualityInfo = document.getElementById('qualityInfo');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        
        const BROADCASTER_ID = "surveillance_camera_001";
        let peer = null;
        let currentStream = null;

        // إعدادات الجودة المختلفة
        const qualityProfiles = {
            high: {
                video: { 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 }, 
                    frameRate: { ideal: 30 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100,
                    sampleSize: 16 
                }
            },
            medium: {
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }, 
                    frameRate: { ideal: 20 } 
                },
                audio: { 
                    channelCount: 1,
                    sampleRate: 44100 
                }
            },
            low: {
                video: { 
                    width: { ideal: 320 }, 
                    height: { ideal: 240 }, 
                    frameRate: { ideal: 15 } 
                },
                audio: true
            },
            audioOnly: {
                video: false,
                audio: true
            }
        };

        // معلومات الجودة للعرض
        const qualityDescriptions = {
            high: "عالي: 1280x720 - 30fps",
            medium: "متوسط: 640x480 - 20fps",
            low: "منخفض: 320x240 - 15fps",
            audioOnly: "الصوت فقط"
        };

        // الأحداث
        startBtn.addEventListener('click', startBroadcast);
        stopBtn.addEventListener('click', stopBroadcast);
        qualitySelect.addEventListener('change', updateQualityInfo);

        // تحديث معلومات الجودة
        function updateQualityInfo() {
            const quality = qualitySelect.value;
            qualityInfo.textContent = qualityDescriptions[quality];
        }

        // بدء البث
        function startBroadcast() {
            const quality = qualitySelect.value;
            const constraints = qualityProfiles[quality];
            
            statusEl.textContent = "🔄 جاري تشغيل الكاميرا والصوت...";
            statusEl.style.color = '#666';
            startBtn.disabled = true;
            qualitySelect.disabled = true;

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    localVideo.srcObject = stream;
                    
                    // الحل 1: استخدام الخادم الرسمي لـ PeerJS مع إعدادات محسنة
                    peer = new Peer(BROADCASTER_ID, {
                        host: '0.peerjs.com',         // الخادم الرسمي
                        port: 443,                   // منفذ HTTPS
                        path: '/',                   المسار
                        secure: true,                // استخدام HTTPS
                        debug: 3,                    // مستوى التصحيح
                        config: {                    // إعدادات ICE servers
                            iceServers: [
                                { 
                                    urls: [
                                        'stun:stun.l.google.com:19302',
                                        'stun:global.stun.twilio.com:3478'
                                    ] 
                                }
                            ]
                        }
                    });

                    peer.on('open', function(id) {
                        statusEl.innerHTML = "✅ <strong>البث نشط!</strong><br>جودة: " + qualityDescriptions[quality] + "<br>جاهز للاستقبال";
                        statusEl.style.color = 'green';
                        stopBtn.disabled = false;
                    });

                    peer.on('error', function(err) {
                        console.error('خطأ في PeerJS:', err);
                        statusEl.innerHTML = "❌ <strong>خطأ في الاتصال:</strong> " + err.type + "<br>جرب تحديث الصفحة";
                        statusEl.style.color = 'red';
                        stopBroadcast();
                    });

                    peer.on('disconnected', function() {
                        statusEl.textContent = "⚠️ فقدان الاتصال. جاري إعادة الاتصال تلقائياً...";
                        statusEl.style.color = 'orange';
                    });

                })
                .catch(function(err) {
                    statusEl.innerHTML = "❌ <strong>خطأ:</strong> " + err.name + "<br>" + err.message;
                    statusEl.style.color = 'red';
                    startBtn.disabled = false;
                    qualitySelect.disabled = false;
                    console.error('Error accessing media:', err);
                });
        }

        // إيقاف البث
        function stopBroadcast() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            localVideo.srcObject = null;
            statusEl.innerHTML = "⏸️ <strong>تم إيقاف البث</strong><br>يمكنك البدء مرة أخرى";
            statusEl.style.color = '#666';
            startBtn.disabled = false;
            qualitySelect.disabled = false;
            stopBtn.disabled = true;
        }

        // إغلاق البث عند مغادرة الصفحة
        window.addEventListener('beforeunload', stopBroadcast);
        
        // تهيئة أولية
        updateQualityInfo();
    </script>
</body>
</html>