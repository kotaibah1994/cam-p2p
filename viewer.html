<!DOCTYPE html>
<html>
<head>
    <title>كاميرا المراقبة - المشاهدة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 20px; 
            background-color: #f5f5f5;
            padding: 10px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        video { 
            width: 100%; 
            max-width: 600px; 
            border: 2px solid #007bff; 
            border-radius: 10px; 
            margin: 15px 0; 
            background-color: #000;
        }
        #status { 
            color: #666; 
            margin: 15px; 
            font-size: 16px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            min-height: 60px;
        }
        button { 
            padding: 12px 24px; 
            margin: 10px; 
            border-radius: 8px; 
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #connectBtn {
            background: #28a745;
            color: white;
        }
        #connectBtn:hover {
            background: #218838;
        }
        #disconnectBtn {
            background: #dc3545;
            color: white;
        }
        #disconnectBtn:hover {
            background: #c82333;
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }
        .status-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-checking {
            background-color: #17a2b8;
            animation: pulse 1.5s infinite;
        }
        .status-available {
            background-color: #28a745;
        }
        .status-unavailable {
            background-color: #dc3545;
        }
        .status-connected {
            background-color: #28a745;
            animation: pulse 1s infinite;
        }
        .header {
            background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .instructions {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: right;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>👀 وضع المشاهدة - كاميرا المراقبة</h2>
            <p>البث المباشر من كاميرا المراقبة</p>
        </div>
        
        <div class="instructions">
            <h3>تعليمات الاستخدام:</h3>
            <ol>
                <li>تأكد من أن جهاز البث يعمل وأن الكاميرا نشطة</li>
                <li>سيتحقق النظام تلقائيًا من وجود البث</li>
                <li>اضغط على "الاتصال" عندما تكون الإشارة خضراء</li>
                <li>استمتع بمشاهدة البث المباشر!</li>
            </ol>
        </div>
        
        <div class="status-indicator">
            <div id="statusDot" class="status-dot status-checking"></div>
            <span id="statusText">جاري التحقق من حالة البث...</span>
        </div>
        
        <div>
            <button id="connectBtn" disabled>🔄 الاتصال بالبث</button>
            <button id="disconnectBtn" disabled>⏹️ قطع الاتصال</button>
        </div>
        
        <video id="remoteVideo" autoplay playsinline></video>

        <div style="margin-top: 20px; color: #666; font-size: 14px;">
            <p>تأكد من أن جهاز البث يعمل على الرابط: <br>
            <strong>https://اسمك.github.io/cam-p2p/broadcaster.html</strong></p>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // عناصر DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const remoteVideo = document.getElementById('remoteVideo');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        
        // معرف الباثن الثابت (يجب أن يتطابق مع المعرف في broadcaster.html)
        const BROADCASTER_ID = "surveillance_camera_001";
        
        let peer = null;
        let currentCall = null;
        let isConnected = false;
        let isBroadcasterAvailable = false;
        let checkInterval = null;
        const CHECK_INTERVAL = 5000; // التحقق كل 5 ثواني

        // تحديث حالة المؤشر
        function updateStatus(status, message) {
            // إزالة جميع classes الحالة
            statusDot.classList.remove('status-checking', 'status-available', 'status-unavailable', 'status-connected');
            
            // إضافة class الحالة الجديدة
            statusDot.classList.add(status);
            statusText.textContent = message;
            
            // تحديث أزرار التحكم
            if (status === 'status-available') {
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            } else if (status === 'status-connected') {
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                connectBtn.disabled = true;
                disconnectBtn.disabled = true;
            }
        }

        // التحقق من وجود الباثن
        function checkBroadcasterAvailability() {
            if (isConnected) return; // لا داعي للتحقق إذا كنا متصلين بالفعل
            
            // إنشاء اتصال مؤقت للتحقق من وجود الباثن
            const tempPeer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                config: {
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                }
            });

            tempPeer.on('open', function() {
                // محاولة الاتصال بالباثن للتحقق من وجوده
                const tempConn = tempPeer.connect(BROADCASTER_ID, { reliable: true });
                
                tempConn.on('open', function() {
                    // الباثن متاح
                    isBroadcasterAvailable = true;
                    updateStatus('status-available', '✅ الباثن متاح! اضغط على "الاتصال" للبدء.');
                    tempConn.close();
                    tempPeer.destroy();
                });
                
                tempConn.on('error', function() {
                    // الباثن غير متاح
                    isBroadcasterAvailable = false;
                    updateStatus('status-unavailable', '❌ الباثن غير متاح. جاري إعادة المحاولة...');
                    tempPeer.destroy();
                });
                
                //设定超时
                setTimeout(function() {
                    if (!isBroadcasterAvailable) {
                        tempPeer.destroy();
                    }
                }, 3000);
            });

            tempPeer.on('error', function() {
                isBroadcasterAvailable = false;
                updateStatus('status-unavailable', '❌ خطأ في الاتصال بالخادم. جاري إعادة المحاولة...');
            });
        }

        // الاتصال بالباثن
        function connectToBroadcaster() {
            if (!isBroadcasterAvailable) {
                updateStatus('status-unavailable', '❌ الباثن غير متاح. لا يمكن الاتصال.');
                return;
            }
            
            updateStatus('status-checking', '🔄 جاري الاتصال بالبث...');
            
            // إنشاء اتصال Peer جديد
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 2,
                config: {
                    iceServers: [
                        { 
                            urls: [
                                'stun:stun.l.google.com:19302',
                                'stun:stun1.l.google.com:19302',
                                'stun:stun2.l.google.com:19302'
                            ] 
                        }
                    ]
                }
            });

            // عند فتح الاتصال مع الخادم
            peer.on('open', function(id) {
                console.log('✅ Connected to signaling server. My ID:', id);
                
                // محاولة الاتصال بالباثن
                try {
                    currentCall = peer.call(BROADCASTER_ID);
                    
                    // عند استقبال تيار الوسائط
                    currentCall.on('stream', function(remoteStream) {
                        console.log('✅ Received remote stream');
                        remoteVideo.srcObject = remoteStream;
                        isConnected = true;
                        updateStatus('status-connected', '✅ متصل بالبث! البث المباشر يعمل بشكل طبيعي');
                    });
                    
                    // عند إغلاق الاتصال
                    currentCall.on('close', function() {
                        console.log('🔌 Call closed');
                        handleDisconnection();
                    });
                    
                    // عند حدوث خطأ في المكالمة
                    currentCall.on('error', function(err) {
                        console.error('❌ Call error:', err);
                        handleDisconnection();
                    });
                    
                } catch (error) {
                    console.error('❌ Error calling peer:', error);
                    handleDisconnection('❌ خطأ في الاتصال. تأكد من أن الباثن نشط.');
                }
            });

            // معالجة أخطاء Peer
            peer.on('error', function(err) {
                console.error('❌ Peer error:', err);
                
                if (err.type === 'peer-unavailable') {
                    handleDisconnection('⏳ الباثن غير متوفر. جاري إعادة المحاولة...');
                } else if (err.type === 'network') {
                    handleDisconnection('❌ مشكلة في الشبكة. تحقق من اتصال الإنترنت.');
                } else {
                    handleDisconnection('❌ خطأ في الاتصال: ' + err.type);
                }
            });
        }

        // معالجة انقطاع الاتصال
        function handleDisconnection(message) {
            isConnected = false;
            
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            remoteVideo.srcObject = null;
            
            if (message) {
                updateStatus('status-unavailable', message);
            } else {
                updateStatus('status-unavailable', '🔌 انقطع الاتصال. جاري إعادة التحقق من الباثن...');
            }
            
            // استئناف التحقق من الباثن
            startChecking();
        }

        // بدء التحقق الدوري من الباثن
        function startChecking() {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            updateStatus('status-checking', '🔍 جاري التحقق من وجود البث...');
            checkBroadcasterAvailability(); // التحقق فوراً
            checkInterval = setInterval(checkBroadcasterAvailability, CHECK_INTERVAL);
        }

        // وقف التحقق الدوري
        function stopChecking() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
            }
        }

        // قطع الاتصال يدوياً
        function disconnect() {
            isConnected = false;
            stopChecking();
            
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            remoteVideo.srcObject = null;
            updateStatus('status-unavailable', '⏸️ تم قطع الاتصال. جاري إعادة التحقق من الباثن...');
            
            // استئناف التحقق من الباثن
            startChecking();
        }

        // إضافة event listeners للأزرار
        connectBtn.addEventListener('click', connectToBroadcaster);
        disconnectBtn.addEventListener('click', disconnect);

        // بدء التحقق التلقائي عند تحميل الصفحة
        window.addEventListener('load', function() {
            startChecking();
        });

        // إغلاق الاتصال عند مغادرة الصفحة
        window.addEventListener('beforeunload', function() {
            disconnect();
        });
    </script>
</body>
</html>